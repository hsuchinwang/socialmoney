function loadUser(){$("#selectuser").html(""),$("#friendlist").html("");var e=$("#name").html().toString();$.post("https://socialmoney.herokuapp.com/find_friend",{name:e},function(t){var l=t.split(".");l.pop();for(var n="<optgroup label='Friends:' class='group-1'>",o=0;o<l.length;o++)n+="<option value='"+l[o]+"'>"+l[o]+"</option>";n+="</optgroup>",$("#selectuser").append(n),$("#friendlist").append(n),$("#selectuser").multiselect("rebuild"),$("#friendlist").multiselect("rebuild"),$.get("https://socialmoney.herokuapp.com/find_user",function(t){var l=t.split("|");l.pop();for(var n="<optgroup label='All users:' class='group-2'>",o=0;o<l.length;o++){var i=l[o].substring(0,l[o].indexOf("%"));n+="<option value='"+i+"'>"+i+"</option>"}n+="</optgroup>",$("#selectuser").append(n),$("#selectuser").multiselect("rebuild"),$("#friendlist").append(n),$("#friendlist").multiselect("rebuild");var s=$('input[value="'+e+'"]');s.prop("disabled",!0),s.parent("li").addClass("disabled")})})}function loadCurrency(){var e=$("#name").html().toString();$.post("https://socialmoney.herokuapp.com/find_my_money",{name:e},function(e){var t=e.split(".");t.pop();for(var l=[],n=[],o=[],i=0;i<t.length;i+=3)l.push(t[i]),n.push(t[i+1]),o.push(t[i+2]);for(var s="",i=0;i<l.length;i++)s+='<option value="'+o[i]*Math.pow(i+1,5)+'">'+l[i]+" 幣, 餘 "+n[i]+"("+o[i]+") 元</option>";s+='<option value="clean">全部清除</option>',$("#selectlist").append(s),$("#selectlist").multiselect("rebuild");var a=$('input[value="0"]');a.prop("disabled",!0),a.parent("li").addClass("disabled")})}function getFriend(){var e=$("#friendlist option:selected"),t="",l=$("#name").html().toString();$(e).each(function(e,l){$(this).parent("optgroup").hasClass("group-2")&&(t+=$(this).val()+".")}),t=t.substring(0,t.length-1),""!=t&&$.post("https://socialmoney.herokuapp.com/addfriend",{name:l,friend:t},function(e){console.log(e)}),$("#friendlist").multiselect("deselectAll",!1),$("#friendlist").multiselect("updateButtonText"),loadUser()}function getSelection(e,t){var l=$("#selectlist option:selected"),n=[],o=[],i=[],s=0,a=$("#name").html().toString();if($(l).each(function(e,t){s+=$(this).val()/Math.pow($(this).index()+1,5),null!=indexOfElement&&$(this).index()==indexOfElement?(n.push($(this).html().substring(0,$(this).html().indexOf("幣")-1)),o.push(topay)):(n.push($(this).html().substring(0,$(this).html().indexOf("幣")-1)),o.push($(this).val()/Math.pow($(this).index()+1,5)))}),e>s)return alert("You don't have enough money!"),void removeImg();e>total&&(n.push($("#name").html().toString()),o.push(e-total));for(var r=0;r<n.length;r++)i.push(n[r]+"幣"+o[r]+"元");return $.post("https://socialmoney.herokuapp.com/minusAvailable",{name:a,currency:n,price:o},function(e){console.log(e)}),""!=t&&($.post("https://socialmoney.herokuapp.com/addfriend",{name:a,friend:t},function(e){console.log(e)}),$.post("https://socialmoney.herokuapp.com/addfriend",{name:t,friend:a},function(e){console.log(e)})),i}function create(){var e=document.getElementById("price").value,t=$("#selectuser option:selected"),l="";t.parent("optgroup").hasClass("group-2")&&(l=t.html().toString(),console.log(l));var n=getSelection(e,l),o="<h4>我用</h4>";if(null!=e&&n.length>0&&t.length>0){var i=$("#name").html().toString()+","+n.join(".")+","+e;console.log(i);var s,a,r,c,p,u;s=Math.floor(10*Math.random()+1),a=Math.floor(10*Math.random()+1),r=Math.floor(10*Math.random()+1),c=Math.floor(10*Math.random()+1),p=Math.floor(10*Math.random()+1),u=(s+a)*r*c*p,$("#pincode").html(u);for(var h=0;h<n.length;h++)o+="<h5>"+n[h]+"</h5>";o+="<h5>共"+e+"元</h5>",o+="<h4>做抵押. 請查收</h4>",document.getElementById("comfirmList").innerHTML=o,$.post("https://socialmoney.herokuapp.com/pincode",{currency:i,pin:u,create:name.html()},function(e){console.log(e)}),$("#myModal").modal("show")}else alert("Please input the price, currency and user correctly!")}function removeImg(){document.getElementById("price").value="",$("#selectlist").multiselect("deselectAll",!1),$("#selectlist").multiselect("updateButtonText"),$("#selectuser").multiselect("deselectAll",!1),$("#selectuser").multiselect("updateButtonText"),$("#pincode").html(""),$("#selectuser").html(""),$("#selectlist").html(""),loadUser(),loadCurrency(),total=0,topay=0}function checkPin(){var e=document.getElementById("userpin").value,t="",l=$("#name").html().toString();""==e?alert("Please input the correct Pin Code."):$.post("https://socialmoney.herokuapp.com/checkpin",{pin:e,name:l},function(e){console.log(e),"fail"!=e.toString()?(t=e.toString(),updateDB(t)):alert("The Pin Code is wrong or it is not for you! Please input the correct one!")}),document.getElementById("userpin").value=""}function updateDB(e){var t=$("#name").html().toString(),l="";e=e.replace(/幣/g,""),e=e.replace(/元/g,""),e=e.replace(/\./g,"");var n=e.split(","),o=n[2],i=n[0],s=n[1].split(/\D+/),a=n[1].split(/\d+/);s.shift(),a.pop(),l+="<h4>您得到：</h4>";for(var r=0;r<a.length;r++)l+="<h5>"+a[r]+" 幣, "+s[r]+"元</h5>";l+="<h5>共"+o+"元</h5>",document.getElementById("checkList").innerHTML=l,$("#mycomfirmModal").modal("show"),$.post("https://socialmoney.herokuapp.com/minus",{name:i,currency:a,price:s},function(e){console.log(e)}),$.post("https://socialmoney.herokuapp.com/add",{name:t,currency:a,price:s},function(e){console.log(e)}),$.post("https://socialmoney.herokuapp.com/keeprecord",{namec:t,named:i,price:o,currency:n[1].toString()},function(e){console.log(e)})}var topay=0,total=0,indexOfElement=null;$("#tabBar").on("click","li",function(e){"#tabRecord"==$(this).find("a").attr("href")&&($("#selectlist").html(""),loadUser(),loadCurrency())}),$(document).ready(function(){var e="";$("#selectuser").multiselect({enableCaseInsensitiveFiltering:!0,buttonWidth:"100%",maxHeight:200,enableCollapsibleOptGroups:!0,buttonText:function(e,t){return 0===e.length?"Select user ":t.val()},onChange:function(t,l){l===!0?($("#selectuser").multiselect("deselect",e),e=$("#selectuser option:selected").val()):l===!1&&(e="")}}),$("#friendlist").multiselect({enableCaseInsensitiveFiltering:!0,buttonWidth:"100%",maxHeight:200,enableCollapsibleOptGroups:!0}),$("#selectlist").multiselect({buttonWidth:"100%",onChange:function(e,t){if(t===!0){if("clean"==e.val()){$("#selectlist").multiselect("deselectAll",!0),$("#selectlist").multiselect("updateButtonText"),total=0;var l=$("#selectlist option").filter(function(){return!$(this).is(":selected")});$("#selectlist").siblings(".multiselect-container");$("#selectlist option").each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!1),e.parent("li").addClass("disabled")})}else if(""==$("#price").val())alert("請輸入價錢!!"),$("#selectlist").multiselect("deselect",e.val());else if(total+=parseInt(e.val()/Math.pow(e.index()+1,5)),total>parseInt($("#price").val())){indexOfElement=e.index(),console.log(indexOfElement),topay=parseInt(e.val()/Math.pow(e.index()+1,5))-(total-parseInt($("#price").val())),total=parseInt($("#price").val());var l=$("#selectlist option").filter(function(){return!$(this).is(":selected")});$("#selectlist").siblings(".multiselect-container");l.each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!0),e.parent("li").addClass("disabled")});var n=$('input[value="clean"]');n.prop("disabled",!1),n.parent("li").addClass("disabled")}}else if(t===!1){total=0,topay=0;var o=$("#selectlist option:selected"),i=[];$(o).each(function(e,t){i.push($(this).val()/Math.pow($(this).index()+1,5))});for(var s=0;s<i.length;s++)total+=parseInt(i[s]);var l=$("#selectlist option").filter(function(){return!$(this).is(":selected")});$("#selectlist").siblings(".multiselect-container");$("#selectlist option").each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!1),e.parent("li").addClass("disabled")})}},buttonText:function(e,t){return 0===e.length?"Select currency  ":e.length>=1?"$ "+total+" will pay":void 0}}),$(function(){$('[data-toggle="tooltip"]').tooltip()}),$("#walletinput").click(function(){var e=$("#name").html().toString();$.post("https://socialmoney.herokuapp.com/find_my_money",{name:e},function(e){var t=e.split(".");t.pop();for(var l=[],n=[],o=[],i=0;i<t.length;i+=3)l.push(t[i]),n.push(t[i+1]),o.push(t[i+2]);for(var s="",a=0;a<l.length;a++)s+='<li class="list-group-item"><span class="glyphicon glyphicon-check" aria-hidden="true"></span> '+l[a]+" 幣, 餘 "+n[a]+" ("+o[a]+") 元</li>";$("#moneylist").html(s)}),$(this).attr("data-toggle","collapse")}),$("#recordinput").click(function(){var e=$("#name").html().toString();$.post("https://socialmoney.herokuapp.com/getrecord",{name:e},function(e){var t=e.split(".");t.pop();for(var l="",n=t.length-1;n>=0;n--)l+='<li class="list-group-item"><span class="glyphicon glyphicon-check" aria-hidden="true"></span> '+t[n]+"</li>";$("#moneylist").html(l)}),$(this).attr("data-toggle","collapse")})});